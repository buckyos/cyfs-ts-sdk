<!DOCTYPE html>
<header>
    <title>Perf Test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</header>
<body>
</body>
<script src="./cyfs.js"></script>
<script>

    class PerfManager {
         constructor() {
            this.dec_id = cyfs.ObjectId.from_base_58("9tGpLNnLYoqCAwmpGKM77dBNpGHtrntzWez9upae3kJk").unwrap();

            this.m_sharedStatck = cyfs.SharedCyfsStack.open_runtime();
            //let param = cyfs.SharedObjectStackParam.new_with_ws_event_ports(21000, 210001).unwrap();
            //this.m_sharedStatck = cyfs.SharedObjectStack.open(param);

            this.m_non = this.m_sharedStatck.non_service();
            this.m_util = this.m_sharedStatck.util();

            // nightly cyfs-perf-service   5aSixgM3QNdxLzBVoAtsKiucZhwPwAgrprvp5XhEHdoq
            // beta cyfs-perf-service   5aSixgM3QNdxLzBVoAtsKiucZhwPwAgrprvp5XhEHdoq
        }

        async perf_example() {
            (await this.m_sharedStatck.online()).unwrap();

            // 获取PerfManager 
            let manager = await cyfs.PerfManager.new("test-perf-h5", 10 /*[1, 1440)*/, 60 * 10 * 1000 /*write interval*/, this.dec_id, this.m_sharedStatck);
            // 对象 一个bdt isolate 
            let perfIsolate = manager.new_isolate("main");
            perfIsolate.begin_request("bdt", "channel");
            await perfIsolate.end_request("bdt", "channel", cyfs.BuckyErrorCode.Unknown, cyfs.Some(cyfs.JSBI.BigInt(100)));

            await perfIsolate.acc("bdt", cyfs.BuckyErrorCode.Unknown, cyfs.JSBI.BigInt(100));
            await perfIsolate.action("bdt", cyfs.BuckyErrorCode.Unknown, "bdt", "404");
            await perfIsolate.record("bdt", cyfs.JSBI.BigInt(100), cyfs.Some(cyfs.JSBI.BigInt(100)));

            console.log("*".repeat(128));

        }
    }

    let perfManager = new PerfManager();

    perfManager.perf_example();

    setInterval(function () {
        perfManager.perf_example();
}, 1000);

</script>
</html>