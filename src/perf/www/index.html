<!DOCTYPE html>
<header>
    <title>Perf Test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</header>
<body>
</body>
<script src="./cyfs.js"></script>
<script>

    class PerfManager {

         constructor() {
            this.m_sharedStatck = cyfs.SharedCyfsStack.open_runtime();
            //let param = cyfs.SharedObjectStackParam.new_with_ws_event_ports(21000, 210001).unwrap();
            //this.m_sharedStatck = cyfs.SharedObjectStack.open(param);

            this.m_non = this.m_sharedStatck.non_service();
            this.m_util = this.m_sharedStatck.util();

            // nightly cyfs-perf-service   5aSixgM3QNdxLzBVoAtsKiucZhwPwAgrprvp5XhEHdoq
            // beta cyfs-perf-service   5aSixgM3QNdxLzBVoAtsKiucZhwPwAgrprvp5XhEHdoq
            
            // this.target = cyfs.ObjectId.from_base_58("5aSixgM3QNdxLzBVoAtsKiucZhwPwAgrprvp5XhEHdoq").unwrap();
            this.dec_id = cyfs.ObjectId.from_base_58("9tGpLNnhNgsRvthUBfmpHjk4ezYhZAyxKCmhDgyRT6MF").unwrap();

        }

        async perf_example() {
            (await this.m_sharedStatck.online()).unwrap();

            // 获取PerfClient 对象 一个bdt isolate
            let client = await cyfs.PerfClient.new("test-perf-h5", "1.0.0", cyfs.Some(this.dec_id), this.m_sharedStatck);
            let perfIsolate = client.new_isolate("main");
            perfIsolate.begin_request("bdt", "channel");
            await perfIsolate.end_request("bdt", "channel", 60 * 1000 , cyfs.Ok(cyfs.Some(cyfs.JSBI.BigInt(100))));

            await perfIsolate.acc("bdt", cyfs.Ok(cyfs.JSBI.BigInt(100)));
            await perfIsolate.action("bdt", cyfs.Ok(["bdt", "404"]));
            await perfIsolate.action("bdt", cyfs.Err(new cyfs.BuckyError(cyfs.BuckyErrorCode.Unknown, "xxx")));
            await perfIsolate.record("bdt", cyfs.JSBI.BigInt(100), cyfs.Some(cyfs.JSBI.BigInt(100)));

            console.log("*".repeat(128));

        }
    }

    let perfManager = new PerfManager();

    perfManager.perf_example();

</script>
</html>